<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Todo App</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <h1>Todo App</h1>
  <h2>Add task</h2>
  <form id="add-form">
    <input type="text" name="description" id="description" placeholder="What do you need to do?">

    <label for="starred">Starred</label>
    <input type="checkbox" name="starred" id="starred">

    <label for="due">due</label>
    <input type="date" name="due" id="due">

    <button type="submit">Add</button>
  </form>

  <div class="output">Loading...</div>

  <script src="helpers.js"></script>
  <script>
    document.getElementById('due').valueAsDate = new Date(Date.now() + (24 * 60 * 60 * 1000));
    const form = document.getElementById('add-form')
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      addTask(e.currentTarget.value);
    })
    const output = document.querySelector('.output');

    function addTask(id) {
      const data = {
        description: form.querySelector('[name=description]').value,
        starred: form.querySelector('[name=starred]').checked,
        due: form.querySelector('[name=due]').value,
      };
      
      ajax(`/task`, 'POST', data)
      .then(data => {
        console.log(data.parsed);
        loadTasks();
      })
      .catch(data => {
        console.log(data.parsed);
      });
    }

    function deleteTask(id) {
      ajax(`/task/${id}`, 'DELETE')
      .then(data => {
        console.log(data.parsed);
        loadTasks();
      });
    }
    
    function loadTasks() {
      ajax('/task', 'GET')
      .then(data => {
        const json = data.parsed;
        output.innerHTML = 
        `<ul>
          ${json.data.map(item => `<li>${item.description} - ${item.due}${item.starred ? ' - star' : ''} - 
          <button class="delete-button" data-id="${item.id}">Delete ${item.id}</button></li>`).join('')}
        </ul>`;

        document.querySelectorAll('.delete-button').forEach(item => {item.addEventListener('click', function (e) {
          deleteTask(e.currentTarget.getAttribute('data-id'));
        })});
      });
    }

    loadTasks();
  </script>
</body>

</html>